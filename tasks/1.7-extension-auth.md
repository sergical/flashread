# Task 1.7: Extension Auth Integration

**Status:** pending  
**Phase:** 1 - Foundation  
**Depends on:** Tasks 1.5, 1.6  
**Estimated Time:** 30-45 minutes

## Goal

Extension knows user's subscription status and can gate premium features.

## Steps

### 1. Add Sign In Button to Popup
- [ ] Add "Sign In" button to `popup.html`/`popup.ts`
- [ ] Show when user is not logged in
- [ ] Opens `https://flashread.com/login?source=extension`

### 2. Extension Auth Callback
- [ ] Create `/auth/extension-callback` page on website
- [ ] After successful login, this page:
  - Generates a short-lived auth token
  - Sends it to extension via `chrome.runtime.sendMessage` or URL scheme
  - Shows "You can close this tab" message

### 3. Store Auth Token
- [ ] Receive token in extension
- [ ] Store in `chrome.storage.sync`:
  ```typescript
  chrome.storage.sync.set({ 
    authToken: token,
    userId: userId 
  });
  ```

### 4. Create User API Endpoint
- [ ] Create `/api/user/route.ts` on website
- [ ] Accepts auth token in header
- [ ] Returns user subscription status:
  ```typescript
  // GET /api/user
  return Response.json({
    id: user.id,
    email: user.email,
    isPro: user.subscription_status !== 'free',
    subscription: {
      status: user.subscription_status,
      expiresAt: user.subscription_expires_at,
    }
  });
  ```

### 5. Check Status on Extension Startup
- [ ] In `service-worker.ts` or `content.ts`:
  ```typescript
  async function checkSubscription(): Promise<boolean> {
    const { authToken } = await chrome.storage.sync.get('authToken');
    if (!authToken) return false;
    
    const res = await fetch('https://flashread.com/api/user', {
      headers: { Authorization: `Bearer ${authToken}` }
    });
    
    if (!res.ok) return false;
    const { isPro } = await res.json();
    
    await chrome.storage.local.set({ isPro });
    return isPro;
  }
  ```

### 6. Add `isPro` to Extension State
- [ ] Create `isPro` flag in local storage
- [ ] Pass to overlay when initializing
- [ ] Update popup to show Pro status

### 7. Update Popup UI
- [ ] When logged in: Show user email + "PRO" badge (if Pro)
- [ ] When logged in (free): Show "Upgrade to Pro" button
- [ ] When not logged in: Show "Sign In" button
- [ ] Add "Sign Out" option

### 8. Gate Premium Features
- [ ] In overlay, check `isPro` before enabling:
  - TTS controls
  - Adaptive audio
  - AI summary request
- [ ] Show upgrade prompt when free user tries premium feature:
  ```typescript
  if (!isPro) {
    showUpgradePrompt('AI Voice Narration is a Pro feature');
    return;
  }
  ```

## Acceptance Criteria

- [ ] Users can sign in from extension popup
- [ ] Extension stores auth token securely
- [ ] `isPro` correctly reflects subscription status
- [ ] Popup shows correct login state and Pro badge
- [ ] Premium features show upgrade prompt for free users
- [ ] Sign out clears auth state

## Extension Permissions

May need to add to `manifest.json`:
```json
{
  "host_permissions": [
    "https://flashread.com/*"
  ]
}
```

## Security Notes

- Auth token should be short-lived or refreshable
- Use HTTPS only
- Validate token on every API call
- Consider token refresh mechanism

## Notes

- Keep auth flow simple (website handles complexity)
- Cache `isPro` locally to avoid API calls on every page
- Refresh subscription status periodically (e.g., daily)
