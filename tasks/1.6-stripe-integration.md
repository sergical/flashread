# Task 1.6: Stripe Integration

**Status:** pending  
**Phase:** 1 - Foundation  
**Depends on:** Task 1.5  
**Estimated Time:** 45-60 minutes

## Goal

Accept payments for Pro subscriptions via Stripe.

## Steps

### 1. Stripe Setup
- [ ] Create Stripe account (or use existing)
- [ ] Get API keys (test mode first)
- [ ] Add to `.env.local`:
  ```
  STRIPE_SECRET_KEY=
  STRIPE_WEBHOOK_SECRET=
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
  ```

### 2. Create Stripe Products
- [ ] Product: "FlashRead Pro"
- [ ] Prices:
  - `price_pro_monthly`: $7/month (recurring)
  - `price_pro_annual`: $60/year (recurring)
  - `price_pro_lifetime`: $149 (one-time)

### 3. Checkout API Route
- [ ] Create `/api/checkout/route.ts`
- [ ] Accept: `priceId`, `userId`
- [ ] Create Stripe Checkout Session
- [ ] Include `client_reference_id` (user ID)
- [ ] Return checkout URL

```typescript
// POST /api/checkout
export async function POST(req: Request) {
  const { priceId } = await req.json();
  const user = await getUser(); // From Supabase
  
  const session = await stripe.checkout.sessions.create({
    mode: priceId === 'price_pro_lifetime' ? 'payment' : 'subscription',
    payment_method_types: ['card'],
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: `${origin}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${origin}/pricing`,
    client_reference_id: user.id,
    customer_email: user.email,
  });
  
  return Response.json({ url: session.url });
}
```

### 4. Webhook Handler
- [ ] Create `/api/webhooks/stripe/route.ts`
- [ ] Verify webhook signature
- [ ] Handle events:

```typescript
switch (event.type) {
  case 'checkout.session.completed':
    // New purchase - update user to Pro
    const session = event.data.object;
    await supabase
      .from('profiles')
      .update({ 
        subscription_status: 'pro',
        stripe_customer_id: session.customer,
      })
      .eq('id', session.client_reference_id);
    break;
    
  case 'customer.subscription.deleted':
    // Subscription cancelled - downgrade
    await supabase
      .from('profiles')
      .update({ subscription_status: 'free' })
      .eq('stripe_customer_id', event.data.object.customer);
    break;
    
  case 'invoice.payment_failed':
    // Payment failed - could add grace period
    break;
}
```

### 5. Success/Cancel Pages
- [ ] `/checkout/success` - Thank you page, redirect to dashboard
- [ ] Pricing page handles cancel (user returns there)

### 6. Account/Billing Page
- [ ] Create `/account` page
- [ ] Show current plan
- [ ] Show subscription status and renewal date
- [ ] "Manage Subscription" â†’ Stripe Customer Portal
- [ ] Create Customer Portal link endpoint

### 7. Connect Pricing Page
- [ ] Wire up "Subscribe" buttons to call `/api/checkout`
- [ ] Handle loading state
- [ ] Redirect to Stripe Checkout

## Acceptance Criteria

- [ ] Users can purchase Pro Monthly ($7)
- [ ] Users can purchase Pro Annual ($60)
- [ ] Users can purchase Lifetime ($149)
- [ ] Webhook updates `subscription_status` in Supabase
- [ ] Users can manage subscription via Customer Portal
- [ ] Success page shows after purchase

## Environment Variables

```
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_PRICE_MONTHLY=price_...
STRIPE_PRICE_ANNUAL=price_...
STRIPE_PRICE_LIFETIME=price_...
```

## Testing

- Use Stripe test mode
- Test card: `4242 4242 4242 4242`
- Use Stripe CLI to forward webhooks locally:
  ```
  stripe listen --forward-to localhost:3000/api/webhooks/stripe
  ```

## Notes

- Start with test mode, switch to live before launch
- Lifetime purchases need different handling (one-time vs subscription)
- Consider adding trial period for subscriptions
