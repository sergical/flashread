# Task 1.5: Supabase Auth Setup

**Status:** pending  
**Phase:** 1 - Foundation  
**Depends on:** Task 1.2  
**Estimated Time:** 45-60 minutes

## Goal

Implement working authentication with Magic Link and Google OAuth.

## Steps

### 1. Supabase Project Setup
- [ ] Create Supabase project
- [ ] Note down: Project URL, Anon Key, Service Role Key
- [ ] Add to `.env.local`:
  ```
  NEXT_PUBLIC_SUPABASE_URL=
  NEXT_PUBLIC_SUPABASE_ANON_KEY=
  SUPABASE_SERVICE_ROLE_KEY=
  ```

### 2. Configure Auth Providers
- [ ] Enable Email (Magic Link) in Supabase Dashboard
- [ ] Enable Google OAuth:
  - Create Google Cloud OAuth credentials
  - Add authorized redirect URI
  - Configure in Supabase

### 3. Create Database Schema
```sql
-- Profiles table (extends auth.users)
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  email TEXT,
  full_name TEXT,
  avatar_url TEXT,
  subscription_status TEXT DEFAULT 'free', -- 'free', 'pro', 'lifetime'
  subscription_expires_at TIMESTAMP,
  stripe_customer_id TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Users can read/update their own profile
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON profiles
  FOR UPDATE USING (auth.uid() = id);

-- Trigger to create profile on signup
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name, avatar_url)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

### 4. Create Supabase Client Libraries
- [ ] `lib/supabase/client.ts` - Browser client
- [ ] `lib/supabase/server.ts` - Server components
- [ ] `lib/supabase/middleware.ts` - Auth middleware

### 5. Build Auth Pages
- [ ] `/login` page:
  - Magic link email input
  - "Sign in with Google" button
  - Link to /signup if needed
- [ ] `/auth/callback` route - Handle OAuth redirects
- [ ] `/auth/confirm` route - Handle magic link confirmation

### 6. Protected Routes
- [ ] Middleware to protect `/dashboard/*` routes
- [ ] Redirect to `/login` if not authenticated
- [ ] Redirect to `/dashboard` after login

### 7. User Menu
- [ ] Add user avatar/menu to Navbar when logged in
- [ ] Show email and subscription status
- [ ] Logout button

## Acceptance Criteria

- [ ] Users can sign up with email (magic link)
- [ ] Users can sign in with Google
- [ ] `/dashboard` redirects to `/login` if not authenticated
- [ ] User session persists across page reloads
- [ ] Logout works correctly
- [ ] Profile created automatically on signup

## Environment Variables

```
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
```

## Notes

- Use `@supabase/ssr` for Next.js integration
- Magic link is simpler to start (no password management)
- Google OAuth increases conversion
